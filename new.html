<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InDrive Profit</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: Arial, sans-serif; margin: 5px; padding: 0; font-size: 10px; line-height: 1.1; }
        h1 { font-size: 14px; text-align: center; margin: 3px 0; }
        form { display: grid; gap: 3px; }
        .row { display: flex; gap: 3px; }
        .row > div { flex: 1; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        label { font-size: 10px; white-space: nowrap; }
        input { padding: 3px; font-size: 10px; width: 100%; box-sizing: border-box; }
        #clipboard { width: calc(100% - 30px); }
        #result { margin-top: 5px; padding: 5px; border: 1px solid #ddd; background-color: #f9f9f9; font-size: 10px; }
        .profit-positive { color: green; font-weight: bold; }
        .profit-negative { color: red; font-weight: bold; }
        .profit-row { display: flex; justify-content: space-between; flex-wrap: wrap; margin-bottom: -10px; }
        button { padding: 3px; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>InDrive Profit</h1>
    <form id="calculatorForm">
        <div class="input-group">
            <label for="clipboard">Paste (e.g., "10,300"):</label>
            <input type="text" id="clipboard" placeholder="Paste distance,fare">
            <button type="button" id="voiceButton">🎤</button>
        </div>
        <div class="row">
            <div class="input-group">
                <label for="distance">Distance (km):</label>
                <input type="number" id="distance" required min="0" step="0.1">
            </div>
            <div class="input-group">
                <label for="fare">Fare (PKR):</label>
                <input type="number" id="fare" required min="0" step="0.1">
            </div>
        </div>
        <div class="row">
            <div class="input-group">
                <label for="commission">Commission (0.12):</label>
                <input type="number" id="commission" min="0" max="1" step="0.01" value="0.12">
            </div>
            <div class="input-group">
                <label for="fuelPrice">Fuel Price (PKR/L):</label>
                <input type="number" id="fuelPrice" min="0" step="0.01" value="264.61">
            </div>
        </div>
        <div class="row">
            <div class="input-group">
                <label for="efficiency">Efficiency (km/L):</label>
                <input type="number" id="efficiency" min="0" step="0.1" value="15">
            </div>
            <div class="input-group">
                <label for="maintenance">Maintenance (PKR/km):</label>
                <input type="number" id="maintenance" min="0" step="0.01" value="3">
            </div>
        </div>
    </form>
    <div id="result"></div>
    
    <script>
        const form = document.getElementById('calculatorForm');
        const clipboardInput = document.getElementById('clipboard');
        const distanceInput = document.getElementById('distance');
        const fareInput = document.getElementById('fare');
        const commissionInput = document.getElementById('commission');
        const fuelPriceInput = document.getElementById('fuelPrice');
        const efficiencyInput = document.getElementById('efficiency');
        const maintenanceInput = document.getElementById('maintenance');
        const resultDiv = document.getElementById('result');
        const voiceButton = document.getElementById('voiceButton');
        
        const corrections = {
            'ben': 'ten', 'then': 'ten', 'den': 'ten', 'tin': 'ten', 'teen': 'ten', 'bean': 'ten', 'team': 'ten',
            'tree': 'three', 'free': 'three', 'for': 'four', 'fore': 'four', 'fife': 'five', 'file': 'five',
            'sex': 'six', 'sicks': 'six', 'sever': 'seven', 'heaven': 'seven', 'ate': 'eight', 'aid': 'eight',
            'mine': 'nine', 'line': 'nine', 'hero': 'zero', 'sear o': 'zero',
            'comma': ',', 'coma': ',', 'common': ',', 'kama': ',', 'kam': ',', 'come on': ',', 'come': ',',
            'point': '.', 'dot': '.',
            // Additional corrections for complex numbers
            'hundreds': 'hundred', 'hunded': 'hundred', 'handred': 'hundred',
            'thirty five': 'thirty-five', 'fifty five': 'fifty-five', 'three fifty five': 'three hundred fifty-five',
            'three fifty': 'three hundred fifty', 'three hundred and fifty': 'three hundred fifty'
        };

        const smallNums = {
            'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5, 'six': 6, 'seven': 7, 'eight': 8, 'nine': 9,
            'ten': 10, 'eleven': 11, 'twelve': 12, 'thirteen': 13, 'fourteen': 14, 'fifteen': 15, 'sixteen': 16,
            'seventeen': 17, 'eighteen': 18, 'nineteen': 19
        };

        const tensNums = {
            'twenty': 20, 'thirty': 30, 'forty': 40, 'fifty': 50, 'sixty': 60, 'seventy': 70, 'eighty': 80, 'ninety': 90,
            'thirty-five': 35, 'fifty-five': 55
        };

        const scales = {
            'hundred': 100, 'thousand': 1000
        };

        function correctMishears(transcript) {
            Object.keys(corrections).forEach(wrong => {
                transcript = transcript.replace(new RegExp(wrong, 'gi'), corrections[wrong]);
            });
            return transcript;
        }

        function wordsToNumbers(str) {
            console.log('Processing transcript:', str); // Debug
            str = correctMishears(str);
            console.log('Corrected transcript:', str); // Debug

            // Split on comma or contextual clues (e.g., "km" for distance, "pkr" for fare)
            let parts = str.split(/[,]|(km.*pkr)/i).map(p => p.trim()).filter(p => p);
            if (parts.length === 1) {
                // If no clear comma, try to split based on number patterns or keywords
                const words = str.split(/\s+/);
                let splitIndex = words.findIndex(w => w.match(/pkr|rs|₨/i)) || words.length;
                parts = [
                    words.slice(0, splitIndex).join(' '),
                    words.slice(splitIndex).join(' ').replace(/pkr|rs|₨/i, '')
                ].map(p => p.trim()).filter(p => p);
            }
            console.log('Split parts:', parts); // Debug

            let dist = parseWords(parts[0] || '');
            let fare = parts[1] ? parseWords(parts[1]) : 0;

            // Validate reasonable ranges
            if (dist > 100) dist = 0; // Assume invalid distance if too large
            if (fare > 10000) fare = 0; // Assume invalid fare if too large

            console.log('Parsed distance:', dist, 'fare:', fare); // Debug
            return `${dist},${fare}`;
        }

        function parseWords(str) {
            if (!str) return 0;
            let words = str.split(/\s+/).filter(w => w);
            console.log('Parsing words:', words); // Debug

            // Handle direct numeric input
            if (words.length === 1 && words[0].match(/^\d+\.?\d*$/)) {
                return parseFloat(words[0]);
            }

            let total = 0;
            let group = 0;
            let i = 0;

            while (i < words.length) {
                let word = words[i].toLowerCase();
                let small = smallNums[word];
                let tens = tensNums[word];
                let scale = scales[word];

                if (small !== undefined) {
                    group += small;
                } else if (tens !== undefined) {
                    group += tens;
                } else if (scale !== undefined) {
                    group *= scale;
                    total += group;
                    group = 0;
                } else if (word.match(/^\d+$/)) {
                    group += parseInt(word);
                } else if (word === 'and' || word.match(/km|pkr|rs|₨/i)) {
                    // Ignore connectors or units
                } else {
                    // Check for multi-word numbers (e.g., "three hundred fifty-five")
                    let nextWords = words.slice(i, i + 3).join(' ').toLowerCase();
                    if (corrections[nextWords]) {
                        let corrected = corrections[nextWords].split(' ');
                        words.splice(i, 3, ...corrected);
                        continue; // Reprocess the corrected words
                    }
                }
                i++;
            }
            total += group;
            return total;
        }

        const getTripCategory = (distance) => {
            if (distance >= 1 && distance <= 5) return { label: 'Ultra-Short Trip', emoji: '🚙' };
            if (distance >= 6 && distance <= 10) return { label: 'Short Trip', emoji: '🚗' };
            if (distance >= 11 && distance <= 20) return { label: 'Medium Trip', emoji: '🚐' };
            if (distance >= 21 && distance <= 30) return { label: 'Long Trip', emoji: '🚚' };
            if (distance >= 31) return { label: 'Extended Trip', emoji: '🚌' };
            return { label: 'Unknown', emoji: '' };
        };
        
        let debounceTimeout;
        const calculateProfit = () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const distance = parseFloat(distanceInput.value);
                const fare = parseFloat(fareInput.value);
                const commissionRate = parseFloat(commissionInput.value);
                const fuelPrice = parseFloat(fuelPriceInput.value);
                const efficiency = parseFloat(efficiencyInput.value);
                const maintenancePerKm = parseFloat(maintenanceInput.value);
                
                if (isNaN(distance) || isNaN(fare) || distance <= 0 || fare <= 0 || 
                    isNaN(commissionRate) || isNaN(fuelPrice) || isNaN(efficiency) || 
                    isNaN(maintenancePerKm) || efficiency <= 0) {
                    resultDiv.innerHTML = '<p style="color: red;">Valid numbers</p>';
                    return;
                }
                
                const commission = fare * commissionRate;
                const netFare = fare - commission;
                const fuelCostPerKm = fuelPrice / efficiency;
                const fuelCost = fuelCostPerKm * distance;
                const maintenanceCost = maintenancePerKm * distance;
                const totalVariableCosts = fuelCost + maintenanceCost;
                const profit = netFare - totalVariableCosts;
                
                const farePct = 100;
                const commissionPct = (commission / fare) * 100;
                const netFarePct = (netFare / fare) * 100;
                const fuelPct = (fuelCost / fare) * 100;
                const maintenancePct = (maintenanceCost / fare) * 100;
                const totalCostsPct = (totalVariableCosts / fare) * 100;
                const profitPct = (profit / fare) * 100;
                
                const trip = getTripCategory(distance);
                
                resultDiv.innerHTML = `
                    <div class="profit-row">
                        <p class="${profit > 0 ? 'profit-positive' : 'profit-negative'}">Profit: ${profit.toFixed(2)} (${profitPct.toFixed(0)}%) ${profit > 0 ? '✅' : '❌'}</p>
                        <p>${trip.label} ${trip.emoji} (${distance.toFixed(1)} km)</p>
                    </div>
                    <p>Fare: ${fare.toFixed(2)} (${farePct.toFixed(0)}%)</p>
                    <p>Fuel Cost: ${fuelCost.toFixed(2)} (${fuelPct.toFixed(0)}%)</p>
                    <p>Commission: ${commission.toFixed(2)} (${commissionPct.toFixed(0)}%)</p>
                    <p>Net Fare: ${netFare.toFixed(2)} (${netFarePct.toFixed(0)}%)</p>
                    <p>Maintenance: ${maintenanceCost.toFixed(2)} (${maintenancePct.toFixed(0)}%)</p>
                    <p>Total Costs: ${totalVariableCosts.toFixed(2)} (${totalCostsPct.toFixed(0)}%)</p>
                `;
            }, 300);
        };
        
        clipboardInput.addEventListener('input', () => {
            const text = clipboardInput.value.toLowerCase().trim();
            const simpleMatch = text.match(/^(\d*\.?\d*)\s*,\s*(\d*\.?\d*)$/);
            if (simpleMatch) {
                distanceInput.value = simpleMatch[1];
                fareInput.value = simpleMatch[2];
            } else {
                const distanceMatch = text.match(/distance\D*(\d*\.?\d*)\s*km/i) || text.match(/(\d*\.?\d*)\s*km/i);
                if (distanceMatch) distanceInput.value = distanceMatch[1];
                const fareMatch = text.match(/fare\D*(\d*\.?\d*)\s*(pkr|rs|₨)/i) || text.match(/(\d*\.?\d*)\s*(pkr|rs|₨)/i);
                if (fareMatch) fareInput.value = fareMatch[1];
            }
            calculateProfit();
        });
        
        [distanceInput, fareInput, commissionInput, fuelPriceInput, efficiencyInput, maintenanceInput].forEach(input => {
            input.addEventListener('input', calculateProfit);
        });

        voiceButton.addEventListener('click', () => {
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser.');
                return;
            }
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-PK';
            recognition.onresult = (event) => {
                let transcript = event.results[0][0].transcript.toLowerCase();
                console.log('Raw transcript:', transcript);
                transcript = correctMishears(transcript);
                const processed = wordsToNumbers(transcript);
                clipboardInput.value = processed;
                clipboardInput.dispatchEvent(new Event('input'));
            };
            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                alert('Speech recognition failed. Try again.');
            };
            recognition.start();
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered', reg)).catch(err => console.error('SW registration failed', err));
        }
    </script>
</body>
</html>
